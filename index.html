<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ficha de Personagem: Cohen Uchiha</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #111827; color: #d1d5db; }
        .card { background-color: #1f2937; border: 1px solid #374151; border-radius: 0.75rem; }
        .card-title { color: #f3f4f6; font-weight: 700; border-bottom: 1px solid #374151; padding-bottom: 0.75rem; margin-bottom: 1rem; display: flex; align-items: center; justify-content: space-between; }
        [contenteditable]:focus { outline: 2px solid #4f46e5; background-color: #374151; border-radius: 0.25rem; padding: 0.25rem; }
        .btn { padding: 0.25rem 0.75rem; border-radius: 0.375rem; font-weight: 500; transition: all 0.2s; cursor: pointer; display: inline-flex; align-items: center; justify-content: center; white-space: nowrap; }
        .btn-primary { background-color: #4f46e5; color: white; }
        .btn-primary:hover { background-color: #4338ca; }
        .btn-success { background-color: #16a34a; color: white; }
        .btn-success:hover { background-color: #15803d; }
        .btn-danger { background-color: #dc2626; color: white; }
        .btn-danger:hover { background-color: #b91c1c; }
        .btn-secondary { background-color: #374151; color: #d1d5db; }
        .btn-secondary:hover { background-color: #4b5563; }
        .progress-bar-container { background-color: #374151; border-radius: 9999px; overflow: hidden; height: 1.25rem; }
        .progress-bar { transition: width 0.5s ease-in-out; text-align: center; color: white; font-weight: 500; font-size: 0.75rem; line-height: 1.25rem; }
        .uchiha-fan { width: 2.5rem; height: 2.5rem; fill: #ef4444; }
        .form-input { background-color: #374151; border: 1px solid #4b5563; border-radius: 0.375rem; padding: 0.5rem; width: 100%; }
        .form-input:focus { outline: none; border-color: #4f46e5; box-shadow: 0 0 0 2px #4f46e5; }
        details > summary { cursor: pointer; list-style: none; }
        details > summary::-webkit-details-marker { display: none; }
        .hidden { display: none; }
        #roll-result-modal { transition: opacity 0.3s ease-in-out; }
    </style>
</head>
<body class="p-4 sm:p-6 md:p-8">

    <div id="roll-result-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center opacity-0 pointer-events-none z-50">
        <div id="roll-result-content" class="bg-gray-800 border border-gray-700 text-white p-8 rounded-xl shadow-lg text-center max-w-sm">
        </div>
    </div>

    <div class="max-w-7xl mx-auto">
        <header class="card p-4 mb-6 flex flex-col sm:flex-row items-center justify-between gap-4">
            <div class="flex items-center gap-4 text-center sm:text-left">
                <svg class="uchiha-fan flex-shrink-0" viewBox="0 0 128 128" xmlns="http://www.w3.org/2000/svg"><path d="M78.6 128C98.4 128 128 98.4 128 78.6a49.5 49.5 0 0 0-14.5-35.3C100.3 29 84.4 22.3 78.6 22.3a125.8 125.8 0 0 0-29.2 4.2C27.7 32.7 11.3 49.8 4.3 71.5 0 84.4 0 98.4 0 98.4V128h78.6z" fill="#fff"></path><path d="M78.6 128c-57.8 0-66-70.9-29.2-91.5C62.6 24.2 78.6 22.3 78.6 22.3c35.3 0 49.4 35.4 35.3 49.4-14.2 14.2-49.4 35.3-35.3 56.3z"></path></svg>
                <div>
                    <h1 class="text-2xl md:text-3xl font-bold text-white">Cohen Uchiha</h1>
                    <p class="text-gray-400">Jounin Comandante de Konoha</p>
                </div>
            </div>
            <div class="text-center sm:text-right">
                <p class="text-gray-400">Idade: 18</p>
                <p class="text-gray-400">Clã: Uchiha</p>
            </div>
        </header>

        <main class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div class="lg:col-span-1 flex flex-col gap-6">
                <div class="card p-6">
                    <h2 class="card-title">Evolução</h2>
                    <div class="flex justify-between items-center gap-4 mb-2">
                        <span class="text-lg">Pontos de Atributo: <span id="level-up-points" class="font-bold text-white text-xl">0</span></span>
                        <button onclick="levelUp()" class="btn btn-primary">Subir de Nível!</button>
                    </div>
                </div>

                 <div class="card p-6">
                    <h2 class="card-title">Recursos</h2>
                    <div class="mb-6">
                        <label class="font-bold text-white">Pontos de Vida (PV)</label>
                        <div class="progress-bar-container mt-2"><div id="hp-bar" class="progress-bar bg-red-600"></div></div>
                        <div class="flex items-center justify-between mt-2">
                             <div class="flex items-center gap-2 w-full">
                                <button onclick="adjustResource('hp', 'subtract')" class="btn btn-danger">-</button>
                                <input type="number" id="hp-adjust-amount" class="form-input w-full text-center" value="1" min="1">
                                <button onclick="adjustResource('hp', 'add')" class="btn btn-primary">+</button>
                            </div>
                            <span id="hp-text" class="font-mono text-lg font-bold text-white ml-4 whitespace-nowrap"></span>
                        </div>
                    </div>
                    <div>
                        <label class="font-bold text-white">Pontos de Chakra (PC)</label>
                        <div class="progress-bar-container mt-2"><div id="chakra-bar" class="progress-bar bg-blue-600"></div></div>
                        <div class="flex items-center justify-between mt-2">
                            <div class="flex items-center gap-2 w-full">
                                <button onclick="adjustResource('chakra', 'subtract')" class="btn btn-danger">-</button>
                                <input type="number" id="chakra-adjust-amount" class="form-input w-full text-center" value="5" min="1">
                                <button onclick="adjustResource('chakra', 'add')" class="btn btn-primary">+</button>
                            </div>
                            <span id="chakra-text" class="font-mono text-lg font-bold text-white ml-4 whitespace-nowrap"></span>
                        </div>
                    </div>
                </div>

                <div class="card p-6">
                    <h2 class="card-title">Atributos</h2>
                    <div id="attributes-list" class="grid grid-cols-1 gap-4 text-lg"></div>
                </div>

                <div class="card p-6">
                    <h2 class="card-title">Kekkei Genkai & Dōjutsu</h2>
                    <div class="space-y-4">
                        <div>
                             <p class="font-bold text-white">Sharingan (Três Tomoe)</p>
                             <p class="text-xs text-gray-400">Custo: 1 PC/turno. Bônus: +2 em AGI, CON, PER.</p>
                             <button id="sharingan-toggle" onclick="toggleSharingan()" class="btn btn-secondary w-full mt-2">Ativar Sharingan</button>
                        </div>
                         <div>
                             <p class="font-bold text-white">Mangekyō Sharingan</p>
                             <p class="text-xs text-red-400">Custo: 4 PC/turno. Bônus: +4 em AGI, CON, PER.</p>
                             <button id="mangekyou-toggle" onclick="toggleMangekyou()" class="btn btn-secondary w-full mt-2">Ativar Mangekyō</button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="lg:col-span-2 flex flex-col gap-6">
                <div id="peacetime-view" class="flex flex-col gap-6">
                    <div class="card p-6">
                        <h2 class="card-title">Informações do Personagem</h2>
                        <div class="space-y-4">
                            <details class="p-2 rounded-md hover:bg-gray-700"><summary class="font-bold text-white text-lg">Identificação</summary><div id="info-identificacao" contenteditable="true" class="mt-2 text-gray-400 text-sm border-l-2 border-gray-600 pl-3"></div></details>
                            <details class="p-2 rounded-md hover:bg-gray-700"><summary class="font-bold text-white text-lg">Aparência</summary><div id="info-aparencia" contenteditable="true" class="mt-2 text-gray-400 text-sm border-l-2 border-gray-600 pl-3"></div></details>
                            <details class="p-2 rounded-md hover:bg-gray-700"><summary class="font-bold text-white text-lg">Vestuário e Equipamento</summary><div id="info-vestuario" contenteditable="true" class="mt-2 text-gray-400 text-sm border-l-2 border-gray-600 pl-3"></div></details>
                            <details class="p-2 rounded-md hover:bg-gray-700"><summary class="font-bold text-white text-lg">Personalidade e Mentalidade</summary><div id="info-personalidade" contenteditable="true" class="mt-2 text-gray-400 text-sm border-l-2 border-gray-600 pl-3"></div></details>
                            <details class="p-2 rounded-md hover:bg-gray-700"><summary class="font-bold text-white text-lg">História (Backstory)</summary><div id="info-historia" contenteditable="true" class="mt-2 text-gray-400 text-sm border-l-2 border-gray-600 pl-3"></div></details>
                        </div>
                    </div>
                    <div class="card p-6">
                        <h2 class="card-title">Inventário</h2>
                        <ul id="inventory-list" class="space-y-3"></ul>
                    </div>
                    <div class="card p-6">
                        <button onclick="startCombat()" class="btn btn-danger w-full text-lg py-3">INICIAR COMBATE</button>
                    </div>
                </div>

                <div id="combat-view" class="hidden flex-col gap-6">
                    <div id="combat-mode-card" class="card p-6"></div>
                    <div id="basic-attacks-card" class="card p-6"></div>
                    <div class="card p-6">
                        <h2 class="card-title">Lista de Jutsus</h2>
                        <div id="jutsu-list" class="space-y-4"></div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script type="module">
        let state = {
            maxHp: 75, currentHp: 75, maxChakra: 120, currentChakra: 120, levelUpPoints: 0,
            isSharinganActive: false, isMangekyouActive: false, hasMangekyou: true,
            characterInfo: {
                identificacao: `<p><b>Nome Completo:</b> Cohen Uchiha</p><p><b>Idade:</b> 18 Anos</p><p><b>Clã:</b> Uchiha</p><p><b>Afiliação:</b> Konohagakure (Aldeia da Folha)</p><p><b>Rank:</b> Jounin Comandante</p><p><b>Título(s):</b> Capitão do Esquadrão Kage; "O Corvo de Olhos Vermelhos"</p>`,
                aparencia: `Aos 18 anos, Cohen já não tem a aparência de um rapaz prodígio, mas sim a de um jovem homem forjado em batalhas. Ele é alto, com uma constituição magra e musculada, construída para velocidade e agilidade. O seu cabelo preto, típico do clã Uchiha, é um pouco mais comprido do que nos seus dias de ANBU, com franjas que por vezes lhe caem sobre os olhos.<br>O seu rosto é pálido e de traços finos, geralmente com uma expressão calma e analítica. Os seus olhos de ônix são a sua característica mais marcante; eles carregam uma intensidade e uma sabedoria que desmentem a sua idade. O seu olho esquerdo, permanentemente danificado pelo uso do Mangekyō, tem uma ligeira e quase impercetível turvação na íris, visível apenas sob luz forte. Ele carrega pequenas cicatrizes da sua carreira, incluindo uma fina linha na sua bochecha e outra no seu antebraço, lembretes das suas batalhas mais difíceis.`,
                vestuario: `<b>Vestuário Padrão:</b> Cohen usa o uniforme padrão de Jounin de Konoha, consistindo num colete verde (flak jacket) sobre um fato de manga comprida azul-escuro. Nas costas do seu colete está orgulhosamente exibido o leque vermelho e branco, o símbolo do Clã Uchiha, um emblema que ele agora carrega com um sentido de dever e honra.<br><b>Equipamento Principal:</b> O seu tantō de lâmina reta, uma herança dos seus dias de ANBU, está amarrado horizontalmente na parte inferior das suas costas para um saque rápido. Ele carrega bolsas de equipamento padrão nas suas coxas, sempre abastecidas com kunais, shurikens, fios de aço e uma variedade de selos explosivos e de fumo.<br><b>Equipamento Pessoal:</b> No seu apartamento, guardada como uma relíquia do seu passado, está a sua antiga máscara ANBU de Corvo. Ele já não a usa, mas ela serve como um lembrete de quem ele foi e do caminho que percorreu.`,
                personalidade: `O Cohen de 18 anos é uma pessoa drasticamente diferente do ANBU de 15. A sua natureza estoica e analítica permanece, mas a sua identidade como uma "ferramenta" foi substituída pela de um líder protetor. Graças às lições de Kakashi e aos laços forjados com a sua equipa, ele aprendeu o valor da confiança e da camaradagem.<br>Ele é um comandante decisivo e um estratega brilhante, capaz de tomar decisões difíceis sob pressão. No entanto, ele carrega o fardo das suas responsabilidades com um peso visível. Ele é ferozmente leal à sua equipa, que ele considera a sua família, e fará qualquer coisa para os proteger. O seu relacionamento íntimo com Hinami tornou-se a sua âncora emocional, um refúgio de humanidade no seu mundo de sombras. Ele lida com o seu poder do Mangekyō com um respeito temeroso, consciente de que cada uso o aproxima de um fim sombrio, tornando as suas decisões de usar o seu poder máximo incrivelmente ponderadas.`,
                historia: `Nascido à sombra do massacre do seu clã, Cohen foi criado para ser um prodígio, destinado a restaurar a honra do nome Uchiha através de uma lealdade inabalável a Konoha. A sua ascensão foi meteórica, culminando no seu recrutamento para a ANBU com o codinome "Corvo".<br>A sua vida mudou para sempre durante a "Missão do Semeador", onde uma simples tarefa de recuperação o arrastou para uma conspiração ligada aos restos da organização Raiz de Danzou. Forçado a tornar-se um líder, ele aprendeu a confiar nos seus companheiros, Hinami Hyuuga e Yoji Aburame. A missão culminou num ataque desesperado ao laboratório principal do Semeador, onde, à beira da morte e a lutar para proteger Hinami, Cohen despertou o Mangekyō Sharingan. Ele usou o poder proibido do Amaterasu para derrotar o seu inimigo, um ato que lhe custou a visão do seu olho esquerdo e quase a sua vida.<br>Após uma longa recuperação, ele foi promovido a Jounin Comandante e colocado sob a tutela de Kakashi Hatake. Nos três anos que se seguiram, ele treinou para controlar o seu novo poder, liderou a sua equipa para desmantelar os últimos vestígios da Raiz, e solidificou a sua reputação como um dos heróis mais formidáveis, embora discretos, de Konoha.`
            },
            attributes: {
                for: { name: 'Força', value: 6 }, agi: { name: 'Agilidade', value: 12 }, vig: { name: 'Vigor', value: 10 },
                int: { name: 'Inteligência', value: 12 }, con: { name: 'Controle', value: 14 }, per: { name: 'Percepção', value: 9 },
            },
            inventory: [
                { name: 'Tantō "Corvo Sombrio"', quantity: 1, type: 'Arma', damage: '1d8 + AGI' },
                { name: 'Kunai', quantity: 20, type: 'Ferramenta', damage: '1d4' },
                { name: 'Papel Bomba', quantity: 15, type: 'Consumível', damage: '3d6' },
            ],
            jutsus: [
                { name: 'Amaterasu', rank: 'S', cost: 30, hpCost: 5, damage: '10d6', desc: 'Olho Esquerdo: Conjura chamas negras inextinguíveis. Causa 5 de dano de ricochete e degrada a visão.' },
                { name: 'Magen: Shinen no Kangoku', rank: 'S', cost: 35, hpCost: 5, damage: 'Especial', desc: 'Olho Direito: Genjutsu. Alvo rola Vigor (CD 25) ou fica Incapacitado por 1d4 turnos.' },
                { name: 'Susanoo (Caixa Torácica)', rank: 'S', cost: 25, damage: '4d12', desc: 'Manutenção: 10 PC/turno. Concede 75 PV temporários. O ataque usa a sua rolagem de Controle.' },
                { name: 'Chidori', rank: 'A', cost: 12, damage: '8d10', desc: 'Uma concentração perfurante de chakra de raio na mão.' },
                { name: 'Lança Afiada de Chidori', rank: 'A', cost: 15, damage: '6d8', desc: 'Estende o Chidori numa lança com alcance de 10 metros.' },
                { name: 'Parede de Trovão', rank: 'B', cost: 10, damage: '4d6', desc: 'Cria uma parede elétrica (5x3m) por 3 turnos. Causa dano e paralisia (Vigor CD 16).' },
                { name: 'Técnica da Grande Bola de Fogo', rank: 'C', cost: 5, damage: '4d6', desc: 'Dispara uma grande esfera de fogo em área.' },
                { name: 'Técnica do Grande Dragão de Fogo', rank: 'B', cost: 10, damage: '6d8', desc: 'Cria uma cabeça de dragão de fogo para incinerar um alvo.' },
                { name: 'Técnica do Fogo do Inferno', rank: 'B', cost: 3, damage: '+1d6', desc: 'Custo por turno. Infunde o tantō com Fogo/Raio, adicionando +1d6 de dano aos ataques.' },
                { name: 'Técnica do Piscar Corporal', rank: 'D', cost: 2, damage: 'Nenhum', desc: 'Move-se a alta velocidade para um ponto visível em 30m. Ação de movimento.' },
                { name: 'Estilo de Saque Rápido: Lua Enevoada', rank: 'A', cost: 0, damage: 'Crítico', desc: 'Uma vez por combate. Ataque de saque com +5 para acertar; se acertar, é um acerto crítico.' }
            ],
            combat: { isActive: false, turn: 0, enemies: [], allies: [] }
        };

        // --- RENDER FUNCTIONS ---
        function renderAll() {
            renderLevelUp(); renderCharacterInfo(); renderAttributes(); renderResources();
            renderInventory(); renderDojutsuButtons(); renderJutsus(); renderBasicAttacks();
        }

        function renderLevelUp() {
            document.getElementById('level-up-points').textContent = state.levelUpPoints;
            renderAttributes();
        }
        
        function renderCharacterInfo() {
            for (const key in state.characterInfo) document.getElementById(`info-${key}`).innerHTML = state.characterInfo[key];
        }

        function renderAttributes() {
            const list = document.getElementById('attributes-list');
            list.innerHTML = '';
            const bonusAttrs = ['agi', 'con', 'per'];
            for (const key in state.attributes) {
                const attr = state.attributes[key];
                let bonus = 0;
                if (bonusAttrs.includes(key)) {
                    if (state.isMangekyouActive) bonus = 4;
                    else if (state.isSharinganActive) bonus = 2;
                }
                const totalValue = attr.value + bonus;
                const element = document.createElement('div');
                element.className = 'flex justify-between items-center';
                element.innerHTML = `
                    <div class="flex items-center gap-2">
                         ${state.levelUpPoints > 0 ? `<button onclick="increaseAttribute('${key}')" class="btn btn-success p-1 w-6 h-6">+</button>` : '<div class="w-6"></div>'}
                        <span>${attr.name}</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <span class="font-bold text-white text-xl">${totalValue} ${bonus > 0 ? `<span class='text-sm text-red-400'>(+${bonus})</span>` : ''}</span>
                        <button onclick="rollAttribute('${key}')" class="btn btn-secondary text-xs">Rolar</button>
                    </div>`;
                list.appendChild(element);
            }
        }

        function renderResources() {
            document.getElementById('hp-text').textContent = `${state.currentHp}/${state.maxHp}`;
            document.getElementById('hp-bar').style.width = `${(state.currentHp / state.maxHp) * 100}%`;
            document.getElementById('chakra-text').textContent = `${state.currentChakra}/${state.maxChakra}`;
            document.getElementById('chakra-bar').style.width = `${(state.currentChakra / state.maxChakra) * 100}%`;
        }
        
        function renderDojutsuButtons() {
            const sharinganBtn = document.getElementById('sharingan-toggle');
            const mangekyouBtn = document.getElementById('mangekyou-toggle');
            mangekyouBtn.textContent = state.isMangekyouActive ? 'Desativar Mangekyō' : 'Ativar Mangekyō';
            mangekyouBtn.classList.toggle('btn-danger', state.isMangekyouActive);
            mangekyouBtn.classList.toggle('btn-secondary', !state.isMangekyouActive);
            sharinganBtn.textContent = state.isSharinganActive ? 'Desativar Sharingan' : 'Ativar Sharingan';
            sharinganBtn.classList.toggle('btn-danger', state.isSharinganActive);
            sharinganBtn.classList.toggle('btn-secondary', !state.isSharinganActive);
        }

        function renderInventory() {
            const list = document.getElementById('inventory-list');
            list.innerHTML = '';
            state.inventory.forEach(item => {
                const li = document.createElement('li');
                li.className = 'p-3 bg-gray-900 rounded-lg flex justify-between items-center';
                li.innerHTML = `
                    <div>
                        <p class="font-bold text-white">${item.name} <span class="text-sm font-normal text-gray-400">(${item.quantity}x)</span></p>
                    </div>
                    <button onclick="rollDamage('${item.damage}', '${item.name}')" class="btn btn-secondary text-xs">Rolar Dano</button>`;
                list.appendChild(li);
            });
        }
        
        function renderJutsus() {
            const list = document.getElementById('jutsu-list');
            list.innerHTML = '';
            state.jutsus.forEach((jutsu, index) => {
                const el = document.createElement('div');
                el.className = 'p-3 border border-gray-700 rounded-lg';
                let costText = `${jutsu.cost} PC` + (jutsu.hpCost ? ` + <span class="text-red-400">${jutsu.hpCost} PV</span>` : '');
                const damageTypes = ['nenhum', 'especial', 'crítico'];
                const canRollDamage = jutsu.damage && !damageTypes.includes(jutsu.damage.toLowerCase());

                el.innerHTML = `
                    <div class="flex justify-between items-start gap-2">
                        <div>
                            <h4 class="font-bold text-white">${jutsu.name} <span class="text-xs font-normal text-gray-400">(Rank ${jutsu.rank})</span></h4>
                            <p class="text-sm text-gray-400">Custo: ${costText}</p>
                            <p class="text-sm text-gray-400">Dano: <span class="text-red-400 font-semibold">${jutsu.damage}</span></p>
                        </div>
                        <div class="flex flex-col items-end gap-2">
                            <button onclick="useJutsu(${index})" class="btn btn-primary text-xs w-full">Usar</button>
                            ${canRollDamage ? `<button onclick="rollDamage('${jutsu.damage}', '${jutsu.name}')" class="btn btn-secondary text-xs w-full">Rolar Dano</button>` : ''}
                        </div>
                    </div>
                    <p class="mt-2 text-gray-300 text-sm">${jutsu.desc}</p>`;
                list.appendChild(el);
            });
        }
        
        function renderBasicAttacks() {
            document.getElementById('basic-attacks-card').innerHTML = `
                <h2 class="card-title">Ataques Básicos</h2>
                <div class="space-y-3">
                    <div class="p-3 bg-gray-900 rounded-lg flex justify-between items-center"><p><span class="font-bold text-white">Tantō "Corvo Sombrio"</span></p><button onclick="rollDamage('1d8 + AGI', 'Tantō')" class="btn btn-secondary text-xs">Rolar Dano</button></div>
                    <div class="p-3 bg-gray-900 rounded-lg flex justify-between items-center"><p><span class="font-bold text-white">Golpe Desarmado</span></p><button onclick="rollDamage('1d4 + FOR', 'Golpe Desarmado')" class="btn btn-secondary text-xs">Rolar Dano</button></div>
                </div>`;
        }

        function renderCombatTracker() {
            const card = document.getElementById('combat-mode-card');
            card.innerHTML = `
                <div class="flex justify-between items-center mb-4">
                    <h2 class="card-title mb-0">Rastreador de Combate</h2>
                    <div class="flex gap-2 items-center">
                        <span class="text-2xl font-bold text-white">Turno: ${state.combat.turn}</span>
                        <button onclick="nextTurn()" class="btn btn-primary">Próximo Turno</button>
                        <button onclick="endCombat()" class="btn btn-secondary">Encerrar Combate</button>
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <h3 class="font-bold text-xl text-green-400 mb-2">Aliados</h3><div id="ally-list" class="space-y-3 mb-4"></div>
                        <div class="p-4 border border-gray-700 rounded-lg"><div class="flex gap-2"><input type="text" id="ally-name" placeholder="Nome" class="form-input w-2/3"><input type="number" id="ally-hp" placeholder="HP" class="form-input w-1/3"><button onclick="addAlly()" class="btn btn-success">Add</button></div></div>
                    </div>
                    <div>
                        <h3 class="font-bold text-xl text-red-400 mb-2">Inimigos</h3><div id="enemy-list" class="space-y-3 mb-4"></div>
                        <div class="p-4 border border-gray-700 rounded-lg"><div class="flex gap-2"><input type="text" id="enemy-name" placeholder="Nome" class="form-input w-2/3"><input type="number" id="enemy-hp" placeholder="HP" class="form-input w-1/3"><button onclick="addEnemy()" class="btn btn-danger">Add</button></div></div>
                    </div>
                </div>`;
            renderCombatantList('ally-list', state.combat.allies, 'ally');
            renderCombatantList('enemy-list', state.combat.enemies, 'enemy');
        }

        function renderCombatantList(listElId, combatants, type) {
            const list = document.getElementById(listElId);
            list.innerHTML = '';
            combatants.forEach((c, i) => {
                const li = document.createElement('div');
                li.className = 'p-3 bg-gray-900 rounded-lg';
                li.innerHTML = `
                    <div class="flex justify-between items-center mb-2"><p class="font-bold text-white">${c.name}</p><button onclick="removeCombatant('${type}', ${i})" class="btn btn-danger text-xs">x</button></div>
                    <div class="progress-bar-container mb-2"><div class="progress-bar ${type === 'ally' ? 'bg-green-600' : 'bg-red-600'}" style="width: ${(c.currentHp/c.maxHp)*100}%">${c.currentHp}</div></div>
                    <div class="flex items-center gap-2"><input type="number" id="damage-input-${type}-${i}" placeholder="Dano/Cura" class="form-input w-full"><button onclick="damageCombatant('${type}', ${i})" class="btn btn-secondary">Aplicar</button></div>`;
                list.appendChild(li);
            });
        }
        
        // --- LOGIC & ACTIONS ---
        window.levelUp = () => { state.levelUpPoints += 2; renderLevelUp(); };
        window.increaseAttribute = (key) => { if(state.levelUpPoints > 0) { state.attributes[key].value++; state.levelUpPoints--; renderLevelUp(); }};
        window.updateResource = (type, amount) => {
            if (type === 'hp') state.currentHp = Math.max(0, Math.min(state.maxHp, state.currentHp + amount));
            else if (type === 'chakra') state.currentChakra = Math.max(0, Math.min(state.maxChakra, state.currentChakra + amount));
            renderResources();
        }
        window.adjustResource = (type, op) => {
            const input = document.getElementById(`${type}-adjust-amount`);
            let amount = parseInt(input.value, 10) || 1;
            updateResource(type, op === 'subtract' ? -amount : amount);
        }
        window.useJutsu = i => {
            const j = state.jutsus[i];
            if (state.currentChakra < j.cost) return alert('Chakra insuficiente!');
            if (j.hpCost && state.currentHp <= j.hpCost) return alert('Vida insuficiente!');
            updateResource('chakra', -j.cost);
            if (j.hpCost) updateResource('hp', -j.hpCost);
        }
        window.toggleSharingan = () => { state.isSharinganActive = !state.isSharinganActive; if (!state.isSharinganActive) state.isMangekyouActive = false; renderDojutsuButtons(); renderAttributes(); };
        window.toggleMangekyou = () => { if (!state.hasMangekyou) return; state.isMangekyouActive = !state.isMangekyouActive; if (state.isMangekyouActive) state.isSharinganActive = true; renderDojutsuButtons(); renderAttributes(); };

        // --- DICE ROLLING ---
        function showRollResult(htmlContent) {
            const modal = document.getElementById('roll-result-modal');
            document.getElementById('roll-result-content').innerHTML = htmlContent;
            modal.classList.remove('opacity-0', 'pointer-events-none');
            setTimeout(() => modal.classList.add('opacity-0', 'pointer-events-none'), 3000);
        }

        window.rollAttribute = (key) => {
            const attr = state.attributes[key];
            let bonus = 0;
            const bonusAttrs = ['agi', 'con', 'per'];
            if (bonusAttrs.includes(key)) {
                if (state.isMangekyouActive) bonus = 4;
                else if (state.isSharinganActive) bonus = 2;
            }
            const totalBonus = attr.value + bonus;
            const roll = Math.floor(Math.random() * 20) + 1;
            const total = roll + totalBonus;
            showRollResult(`<p class="text-lg font-bold mb-2">Teste de ${attr.name}</p><p class="text-6xl font-bold my-4">${total}</p><p class="text-sm text-gray-400">d20(<span class="text-white font-bold">${roll}</span>) + Bônus(<span class="text-white font-bold">${totalBonus}</span>)</p>`);
        }
        
        window.rollDamage = (damageString, sourceName) => {
            if (!damageString || damageString === 'N/A') return;
            let totalDamage = 0; let rolls = []; let bonus = 0; let formula = damageString;
            
            formula = formula.replace('AGI', state.attributes.agi.value).replace('FOR', state.attributes.for.value);
            
            const parts = formula.split('+');
            const dicePart = parts.find(p => p.includes('d'));
            
            if (dicePart) {
                const [numDice, diceType] = dicePart.trim().split('d').map(s => parseInt(s));
                for (let i = 0; i < numDice; i++) {
                    const roll = Math.floor(Math.random() * diceType) + 1;
                    rolls.push(roll);
                    totalDamage += roll;
                }
            }
            parts.forEach(p => { if (!p.includes('d')) bonus += parseInt(p.trim()) || 0; });
            totalDamage += bonus;

            showRollResult(`<p class="text-lg font-bold mb-2">Dano: ${sourceName}</p><p class="text-6xl font-bold my-4 text-red-400">${totalDamage}</p><p class="text-sm text-gray-400">${formula}</p>${rolls.length > 0 ? `<p class="text-xs text-gray-500 mt-2">Rolagens: ${rolls.join(', ')}</p>` : ''}`);
        }

        // --- COMBAT FUNCTIONS ---
        window.startCombat = () => { state.combat.isActive = true; state.combat.turn = 1; document.getElementById('peacetime-view').classList.add('hidden'); document.getElementById('combat-view').classList.remove('hidden'); renderCombatTracker(); };
        window.endCombat = () => { state.combat.isActive = false; document.getElementById('combat-view').classList.add('hidden'); document.getElementById('peacetime-view').classList.remove('hidden'); };
        window.nextTurn = () => { state.combat.turn++; if (state.isMangekyouActive) updateResource('chakra', -4); else if (state.isSharinganActive) updateResource('chakra', -1); renderCombatTracker(); };
        const addCombatant = (type) => { const name = document.getElementById(`${type}-name`).value.trim() || (type === 'ally' ? 'Aliado' : 'Inimigo'); const hp = parseInt(document.getElementById(`${type}-hp`).value, 10) || 10; const list = state.combat[type === 'ally' ? 'allies' : 'enemies']; list.push({ name: `${name} #${list.length + 1}`, maxHp: hp, currentHp: hp }); document.getElementById(`${type}-name`).value = ''; document.getElementById(`${type}-hp`).value = ''; renderCombatantList(`${type}-list`, list, type); };
        window.addAlly = () => addCombatant('ally'); window.addEnemy = () => addCombatant('enemy');
        window.damageCombatant = (type, i) => { const input = document.getElementById(`damage-input-${type}-${i}`); const damage = parseInt(input.value, 10); if (!isNaN(damage)) { const list = state.combat[type === 'ally' ? 'allies' : 'enemies']; list[i].currentHp = Math.max(0, list[i].currentHp - damage); input.value = ''; renderCombatantList(`${type}-list`, list, type); }};
        window.removeCombatant = (type, i) => { const list = state.combat[type === 'ally' ? 'allies' : 'enemies']; list.splice(i, 1); renderCombatantList(`${type}-list`, list, type); };

        // --- INITIALIZATION ---
        window.onload = () => {
            renderAll();
            document.querySelectorAll('[contenteditable="true"]').forEach(el => {
                el.addEventListener('blur', (e) => state.characterInfo[e.target.id.split('-')[1]] = e.target.innerHTML);
            });
        };
    </script>
</body>
</html>
